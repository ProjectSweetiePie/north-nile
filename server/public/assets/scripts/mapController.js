angular.module("northApp").controller("MapController",["ngAudio","ResourceFactory","UserTrackFactory","$scope","leafletData","leafletMarkerEvents","$mdDialog","$http","$location",function(a,b,c,d,e,f,g,h,i){var j=this,k=c.getUserData();k.then(function(a){j.user=a.data}),j.routeUser=function(){1==j.user.is_admin?i.path("/admin"):i.path("/user")};var l={iconUrl:"assets/img/nature-1.svg",iconSize:[38,95],shadowSize:[50,64],iconAnchor:[22,94],shadowAnchor:[4,62],popupAnchor:[-3,-76]},m={iconUrl:"assets/img/orangeBlackCulinary.svg",iconSize:[38,95],shadowSize:[50,64],iconAnchor:[22,94],shadowAnchor:[4,62],popupAnchor:[-3,-76]},n={iconUrl:"assets/img/front-store.svg",iconSize:[38,95],shadowSize:[50,64],iconAnchor:[22,94],shadowAnchor:[4,62],popupAnchor:[-3,-76]},o={iconUrl:"assets/img/lightblueWhiteTruck.psd.svg",iconSize:[38,95],shadowSize:[50,64],iconAnchor:[22,94],shadowAnchor:[4,62],popupAnchor:[-3,-76]};j.storedMarkers=b.mapResources,j.newResource={},j.markerSize=Object.keys(j.storedMarkers).length,j.count=j.markerSize+1,j.visibleMarkers={},j.filterMarkers=function(a,b){j.visibleMarkers={};var c=angular.element(document.querySelector("#filter1")),d=angular.element(document.querySelector("#filter2")),e=angular.element(document.querySelector("#filter3")),f=angular.element(document.querySelector("#filter4"));switch(a){case"Community Garden":c.toggleClass("disabledKeyButton"),console.log("filter1:",c);break;case"Culinary Arts":d.toggleClass("disabledKeyButton");break;case"Food Hub":e.toggleClass("disabledKeyButton");break;case"Food Distribution":f.toggleClass("disabledKeyButton")}if("all"===a)for(marker in j.storedMarkers)j.storedMarkers[marker].visibility=!0,"Community Garden"==j.storedMarkers[marker].resource_type&&(j.storedMarkers[marker].icon=l),"Culinary Arts"==j.storedMarkers[marker].resource_type&&(j.storedMarkers[marker].icon=m),"Food Hub"==j.storedMarkers[marker].resource_type&&(j.storedMarkers[marker].icon=n),"Food Distribution"==j.storedMarkers[marker].resource_type&&(j.storedMarkers[marker].icon=o);else if("none"===a)for(marker in j.storedMarkers)j.storedMarkers[marker].visibility=!1;else for(marker in j.storedMarkers)j.storedMarkers[marker].resource_type===a&&(j.storedMarkers[marker].visibility=!j.storedMarkers[marker].visibility);for(marker in j.storedMarkers)j.storedMarkers[marker].visibility&&(j.visibleMarkers["m"+j.count]=j.storedMarkers[marker],j.count++);angular.extend(j,{markers:j.visibleMarkers})},j.lastClicked={},j.openInfoDrawer=function(b,c){j.showInfoDrawer=!0,j.showNewResourceDrawer=!1,j.lastClicked=c.model,j.lastClicked.audio_reference&&(j.lastClicked.sound=a.load(j.lastClicked.audio_reference)),angular.extend(j,{center:{lat:j.lastClicked.lat,lng:j.lastClicked.lng,zoom:15}})},j.closeInfoDrawer=function(a,b){j.showInfoDrawer&&(j.showInfoDrawer=!1,angular.extend(j,{center:{lat:j.lastClicked.lat,lng:j.lastClicked.lng,zoom:15}}))},j.currentIndex=0,j.setCurrentSlideIndex=function(a){j.currentIndex=a},j.isCurrentSlideIndex=function(a){return j.currentIndex===a},j.prevSlide=function(){j.currentIndex=j.currentIndex<j.lastClicked.images.length-1?++j.currentIndex:0},j.nextSlide=function(){j.currentIndex=j.currentIndex>0?--j.currentIndex:j.lastClicked.images.length-1},j.play=function(a){console.log("audio play:",a),1==j.playing?a.pause():a.play()},j.stop=function(a){console.log("audio stop:",a),a.setCurrentTime(0),a.pause()},j.mute=function(){j.muted?(a.unmute(),j.muted=!1):(a.mute(),j.muted=!0)},j.saveResourceCoords=function(a,b){console.log("saving args:",b),j.newResource.latitude=b.leafletEvent.latlng.lat,j.newResource.longitude=b.leafletEvent.latlng.lng},j.addNewResource=function(){j.showNewResourceDrawer?(j.newResource.account_id=j.user.id,j.showNewResourceDrawer=!1):(j.showNewResourceDrawer=!0,j.user?(j.showNewResourceForm=!0,j.showNewResourceLogin=!1,j.showNewResourceRegister=!1):(j.showNewResourceLogin=!0,j.showNewResourceRegister=!1,j.showNewResourceForm=!1))},b.getSavedResources(j.filterMarkers),d.$on("leafletDirectiveMarker.map.click",j.openInfoDrawer),d.$on("leafletDirectiveMap.map.click",j.closeInfoDrawer),d.$on("leafletDirectiveMap.map.contextmenu",j.saveResourceCoords),angular.extend(j,{defaults:{scrollWheelZoom:!1,touchZoom:!0,dragging:!0,tap:!0,tapTolerance:100},center:{lat:44.996121,lng:-93.295845,zoom:15},tiles:{url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"},markers:j.visibleMarkers}),j.loginUser=function(){h.post("/login",j.loginInfo).then(function(a){200==a.status&&(j.user=a.data,console.log("successful login",a.data.is_admin),a.data.is_admin===!0?(console.log("admin is true"),j.loginInfo={},j.showNewResourceLogin=!1,j.showNewResourceForm=!0):(console.log("admin is not true"),j.loginInfo={},j.showNewResourceLogin=!1,j.showNewResourceForm=!0))},function(a){function b(){alert=g.alert({title:"Attention",textContent:"Incorrect username and/or password. Please enter information again.",ok:"Close"}),g.show(alert)["finally"](function(){alert=void 0})}console.log("unsuccessful login"),b(),j.loginInfo={}})},j.registerShow=function(){j.showNewResourceLogin=!1,j.showNewResourceRegister=!0},j.registerInfo={},j.passwordMismatch=function(){return j.registerInfo.password!==j.registerInfo.confirm_password?!0:void 0},j.passwordMismatchError=function(){return j.passwordMismatch()&&j.registerFormInputs.confirm_password.$dirty?!0:void 0},j.registerUser=function(){h.post("/register",j.registerInfo).then(function(a){200==a.status&&(console.log("successful registration"),j.loginInfo={username:j.registerInfo.username},j.registerInfo={},j.showNewResourceRegister=!1,j.showNewResourceLogin=!0)},function(a){function b(){void 0===j.registerInfo.username?j.alertMessage="Username field cannot be blank":j.alertMessage="Username already exists, please choose another.",alert=g.alert({title:"Attention",textContent:j.alertMessage,ok:"Close"}),g.show(alert)["finally"](function(){alert=void 0})}console.log("unsuccessful registration"),b(),j.registerInfo.username=void 0})},j.saveNewResource=function(a){j.showNewResourceForm,console.log("Saving new resource from user:",j.user),a.account_id=j.user.id,b.saveNewResource(a),j.showNewResourceDrawer=!1,j.newResource={}},j.cancelNewResource=function(){j.showNewResourceDrawer=!1,j.newResource={}},console.log("Map controller loaded.")}]);